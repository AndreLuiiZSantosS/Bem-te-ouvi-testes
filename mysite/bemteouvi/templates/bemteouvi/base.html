<!DOCTYPE html>
<html lang="pt-br">
{% load static %}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  {% block css %}
  <link rel="stylesheet" href="{% static 'bemteouvi/css/base.css' %}">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/criar_evento.css'%}">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/criar_musica.css'%}">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/index.css' %}">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/playlist.css'%}">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/buscar.css' %}">


  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/perfil_musico.css'%}">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/capa_musica.css' %}">


  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'bemteouvi/css/perfil_ouvinte.css'%}">

  {% endblock %}
  <link rel="icon" href="{% static 'bemteouvi/img/bird.png'%}" type="image/png" />
  <title>{% block titulo %} {% endblock %}</title>
  <script src="https://unpkg.com/htmx.org@1.9.3"></script>

</head>

<body>
  <header>
    <a href="{% url 'bemteouvi:index' %}" 
      hx-get="{% url 'bemteouvi:index' %}" 
      hx-target="main" 
      hx-swap="innerHTML"
      hx-push-url="true">
      <figure>
        <img src="{% static 'bemteouvi/img/Logo1.png' %}" alt="bem-te-ouvi logo" id="logo" />
      </figure>
    </a>

    <!-- ✅ Search Form Fixed -->
    <div id="headerCentro">
      <form action="{% url 'bemteouvi:buscar' %}" method="get" id="search-form">
        <input type="text" name="q" id="headerBuscar" placeholder="O que você quer ouvir?" required />
        <button type="submit" id="searchButton">
          <img src="{% static 'bemteouvi/img/base/search.png' %}" alt="Buscar" />
        </button>
      </form>
    </div>

    <div id="headerDireita">

      {% if user.is_authenticated %}
        <!-- <form action="{% url 'bemteouvi:logout' %}" method="post">
          {% csrf_token %}
          <button type="submit">Sair</button>
        </form> -->
        <form id="logout-form" method="POST" action="{% url 'bemteouvi:logout' %}">
          {% csrf_token %}
          <button type="submit" id="botao_sair">Sair</button>
        </form>

        <span id="usuarioLogado">{{ perfil_usuario }}</span>
        {% if user.musico %}
          <a href="{% url 'bemteouvi:perfil-musico' %}" 
          hx-get="{% url 'bemteouvi:perfil-musico' %}" 
          hx-target="main" 
          hx-swap="innerHTML"
          hx-push-url="true">
            <figure>
              <img src="{{ perfil_usuario.foto_url }}" alt="perfil" id="perfil" />
            </figure>
          </a>
          {% else %}
          <a href="{% url 'bemteouvi:perfil-ouvinte' %}" 
          hx-get="{% url 'bemteouvi:perfil-ouvinte' %}" 
          hx-target="main" 
          hx-swap="innerHTML"
          hx-push-url="true">
            <figure>
              <img src="{{ perfil_usuario.foto_url }}" alt="perfil" id="perfil" />
            </figure>
          </a>
          {% endif %}
      {% endif %}
    </div>

    {% if not user.is_authenticated %}
    <a href="{% url 'bemteouvi:login' %}" id="loginUsuario">login</a>
    <a href="{% url 'bemteouvi:cadastro' %}" id="cadastrarUsuario">cadastrar-se</a>
    <figure>
      <a href="{% url 'bemteouvi:login' %}">
        <img src="{% static 'bemteouvi/img/perfil.png' %}" alt="perfil" id="perfil" />
      </a>
    </figure>
    {% endif %}

    </div>
  </header>

  <aside>
    <nav>
      <a href="{% url 'bemteouvi:index' %}" 
      hx-get="{% url 'bemteouvi:index' %}" 
      hx-target="main" 
      hx-swap="innerHTML"
      hx-push-url="true">
      
        <div class="asideTopic">
          <figure><img src="{% static 'bemteouvi/img/base/home.png' %}" alt="pagina principal" /></figure>
          <span>Página principal</span>
        </div>
      </a>

      <a href="{% url 'bemteouvi:playlist' %}"    
      hx-get="{% url 'bemteouvi:playlist' %}"    
      hx-target="main"   
      hx-swap="innerHTML"
      hx-push-url="true">
        <div class="asideTopic">
          <figure><img src="{% static 'bemteouvi/img/base/folder-music.png' %}" alt="suas playlists" /></figure>
          <span>Suas playlists</span>
        </div>
      </a>

      {% if user.musico %}
      <a href="{% url 'bemteouvi:criar-musica' %}"    
      hx-get="{% url 'bemteouvi:criar-musica' %}"    
      hx-target="main"   
      hx-swap="innerHTML"
      hx-push-url="true">
        <div class="asideTopic">
          <figure><img src="{% static 'bemteouvi/img/base/music-alt.png' %}" alt="publicar musica" /></figure>
          <span>Publicar Música</span>
        </div>
      </a>

      <a href="{% url 'bemteouvi:criar-evento' %}"    
      hx-get="{% url 'bemteouvi:criar-evento' %}"    
      hx-target="main"   
      hx-swap="innerHTML"
      hx-push-url="true">
        <div class="asideTopic">
          <figure><img src="{% static 'bemteouvi/img/base/calendar.png' %}" alt="anunciar evento" /></figure>
          <span>Anunciar Evento</span>
        </div>
      </a>
      {% endif %}
    </nav>
  </aside>

  <main hx-target="this" hx-swap="innerHTML">
    {% block conteudo %}
    {% endblock %}
  </main>

  <!-- Player fixo sempre visível -->
<div id="player">
  <!-- Barra de progresso -->
  <div id="player-progress">
    <div id="player-progress-bar"></div>
  </div>

  <!-- UI do player -->
  <div id="player-ui">
    <!-- Título sempre alinhado à esquerda -->
    <span id="titulo-musica">Nenhuma música</span>

    <!-- Controles centralizados -->
    <div id="player-controls">
      <button id="botao-prev">Voltar</button>
      <button id="botao-play">Play</button>
      <button id="botao-next">Próxima</button>
    </div>

    <!-- Elemento <audio> escondido -->
    <audio id="audio-player" preload="metadata"></audio>
  </div>
</div>


  <!-- Script global do player -->
  
{% block scripts %}
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  
    // Inicializa o token CSRF lendo o cookie
    let csrftoken = getCookie('csrftoken');
  
    // Adiciona o header X-CSRFToken para todas requisições HTMX
    document.body.addEventListener('htmx:configRequest', (event) => {
      event.detail.headers['X-CSRFToken'] = csrftoken;
    });
  
    // Após HTMX trocar o conteúdo (por exemplo, recarregar formulário),
    // atualiza o token CSRF armazenado no JS
    document.body.addEventListener('htmx:afterSwap', (event) => {
      const newTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (newTokenInput) {
        const newToken = newTokenInput.value;
        csrftoken = newToken;
      }
    });
  </script>

  <!-- seus outros scripts externos continuam aqui -->
  <script src="{% static 'bemteouvi/js/player.js' %}"></script>
  <script src="{% static 'bemteouvi/js/index.js' %}"></script>
  <script src="{% static 'bemteouvi/js/criarMusica.js' %}"></script>
  <script src="{% static 'bemteouvi/js/criarEvento.js' %}"></script>
  <script src="{% static 'bemteouvi/js/letra.js'%}"></script>
  <script src="{% static 'bemteouvi/js/perfil_musico.js'%}"></script>
  <script src="{% static 'bemteouvi/js/perfil_ouvinte.js'%}"></script>
  <script src="{% static 'bemteouvi/js/perfil_usuario.js'%}"></script>
  <script src="{% static 'bemteouvi/js/playlist.js'%}"></script>
{% endblock %}

  
</body>
</html>